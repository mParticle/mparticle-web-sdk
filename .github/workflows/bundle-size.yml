name: Calculate Bundle Size Difference

on: workflow_dispatch

jobs:
    build-master:
        name: Get Bundle Size from Master
        runs-on: ubuntu-latest
        steps:
            - name: Checkout Master
              uses: actions/checkout@v2
              with:
                  ref: master

            - name: NPM install
              uses: actions/setup-node@v1
              with:
                  # TODO: Make this 16x
                  node-version: 12.x

            - name: Run NPM CI
              run: npm ci

            - name: Build Files
              run: npm run build

            - name: Create Bundle
              # TODO: Make this a real script
              # run: npm run bundle
              run: |
                  npx uglify-js dist/mparticle.js --output dist/mparticle.min.js
                  gzip -c dist/mparticle.min.js > dist/mparticle.min.js.gz

            - name: Report Size
              # TODO: Enable this for real
              # run: |
              #     npm run report:unbundled
              #     npm run report:bundled
              run: |
                  ls -lh dist/mparticle.js | awk '{print $5}'
                  ls -lh dist/mparticle.min.js.gz | awk '{print $5}'

            - name: Set Master Unbundled Size
              id: set-unbundled-master
              # TODO: Remember that this is not human readable
              run: echo "::set-output name=unbundledMaster::$(ls -l dist/mparticle.js | awk '{print $5}')"

            - name: Set Master Bundled Size
              id: set-bundled-master
              # TODO: Remember that this is not human readable
              run: echo "::set-output name=bundledMaster::$(ls -l dist/mparticle.min.js.gz | awk '{print $5}')"

            - name: Archive npm failure logs
              uses: actions/upload-artifact@v2
              if: failure()
              with:
                  name: npm-logs
                  path: ~/.npm/_logs

    build-local:
        name: Get Bundle Size from Current Branch
        runs-on: ubuntu-latest
        steps:
            - name: Checkout
              uses: actions/checkout@v2

            - name: NPM install
              uses: actions/setup-node@v1
              with:
                  node-version: 16.x

            - name: Run NPM CI
              run: npm ci

            - name: Build Files
              run: npm run build

            - name: Create Bundle
              run: npm run bundle

            - name: Report Size
              run: |
                  npm run report:unbundled
                  npm run report:bundled

            - name: Archive npm failure logs
              uses: actions/upload-artifact@v2
              if: failure()
              with:
                  name: npm-logs
                  path: ~/.npm/_logs

    calculate-diff:
        name: Calculate Bundle Size Difference
        runs-on: ubuntu-latest
        needs:
            - build-master
            - build-local
        steps:
            - name: Output Master Sizes
              run: |
                  echo ${{ jobs.build-master.steps.set-unbundled-master.outputs.unbundledMaster}}
                  echo ${{ jobs.build-master.steps.set-bundled-master.outputs.bundledMaster}}
